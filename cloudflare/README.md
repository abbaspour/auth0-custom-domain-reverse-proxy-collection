# Cloudflare Workers for Auth0 Custom Domain

This directory contains the configuration for using Cloudflare Workers as a reverse proxy for Auth0 custom domains.

[Return to main README](../README.md)

## Overview

Cloudflare Workers provide a serverless execution environment that allows you to create entirely new applications or augment existing ones without configuring or maintaining infrastructure. In this implementation, we use Cloudflare Workers to:

- Intercept requests to your custom domain
- Forward them to Auth0 with the required `cname-api-key` header
- Return the response from Auth0 to the client

This approach is serverless, requiring no infrastructure management, and leverages Cloudflare's global network for low-latency responses.

## Implementation Options

This directory includes the following implementation options:

### Worker Fetch API

The `worker-fetch` directory contains an implementation using the Fetch API, which is the recommended approach for most use cases. This implementation:

- Uses the Fetch API to forward requests to Auth0
- Adds the required `cname-api-key` header
- Preserves all request properties (method, headers, body)

## Prerequisites

- A Cloudflare account
- A domain managed by Cloudflare
- Wrangler CLI installed (Cloudflare Workers CLI)
- Environment variables set in `wrangler.toml` file (created by Terraform)

## Setup

1. Run Terraform to create the Auth0 custom domain and generate the configuration:
   ```
   cd ../terraform
   terraform apply
   ```

2. Deploy the Cloudflare Worker:
   ```
   cd ../cloudflare/worker-fetch
   make deploy
   ```

3. Configure your domain to route traffic to the Worker:
   ```
   make route
   ```

## Available Commands

- `make deploy` - Deploy the Cloudflare Worker
- `make route` - Configure the route for your domain
- `make dev` - Start a local development server
- `make logs` - View logs from the deployed Worker
- `make help` - Show help message

## Configuration Files

- `index.mjs` - The Cloudflare Worker code
- `wrangler.toml` - Configuration for the Cloudflare Worker
- `.env` - Environment variables (generated by Terraform)

## Environment Variables

The following environment variables are required:
- `CNAME_API_KEY` - API key for Auth0 custom domain
- `AUTH0_EDGE_LOCATION` - Auth0 edge location domain

These variables are automatically set in the `wrangler.toml` file by Terraform.

## Troubleshooting

- Check the logs with `make logs`
- Ensure the `wrangler.toml` file exists and contains the required variables
- Verify that your domain is correctly configured in Cloudflare
- Make sure the Worker route is correctly set up