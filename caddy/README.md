# Caddy Reverse Proxy for Auth0 Custom Domain

This directory contains the configuration for using Caddy as a reverse proxy for Auth0 custom domains.

## Overview

Caddy is configured to:
- Listen on port 8080 for HTTP traffic and redirect it to HTTPS
- Listen on port 8443 for HTTPS traffic and proxy it to Auth0
- Use Let's Encrypt SSL certificates
- Add the required `cname-api-key` header to requests to Auth0

## Prerequisites

- Caddy installed on your system
- Let's Encrypt certificates for your domain
- Environment variables set in `.env` file (created by Terraform)

## Setup

1. Run Terraform to create the Auth0 custom domain and generate the `.env` file:
   ```
   cd ../terraform
   terraform apply
   ```

2. Obtain a Let's Encrypt certificate for your domain:
   ```
   cd ../letsencrypt
   ./cert.sh <domain>
   ```

3. Start Caddy:
   ```
   make run
   ```

## Available Commands

- `make` or `make all` - Generate certificate and run Caddy
- `make letsencrypt` - Obtain a Let's Encrypt SSL certificate
- `make renew-cert` - Renew Let's Encrypt SSL certificate
- `make run` - Run Caddy on ports 8080 and 8443
- `make stop` - Stop Caddy
- `make reload` - Reload Caddy configuration
- `make log` - View logs
- `make help` - Show help message

## Configuration Files

- `Caddyfile.template` - Template for Caddy configuration
- `Caddyfile` - Generated Caddy configuration (do not edit directly)
- `.env` - Environment variables (generated by Terraform)

## Environment Variables

The following environment variables are required:
- `CNAME_API_KEY` - API key for Auth0 custom domain
- `AUTH0_EDGE_LOCATION` - Auth0 edge location domain
- `DOMAIN_NAME` - Your custom domain name

These variables are automatically set in the `.env` file by Terraform.

## SSL Certificates

Caddy is configured to use Let's Encrypt certificates from the standard location. The certificates are obtained using the scripts in the `../letsencrypt/` directory.

## Troubleshooting

- Check the logs with `make log`
- Ensure the `.env` file exists and contains the required variables
- Verify that the SSL certificates exist in the expected location
- Make sure Caddy is installed and available in your PATH