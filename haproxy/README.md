# HAProxy Reverse Proxy for Auth0 Custom Domain

This directory contains the configuration for using HAProxy as a reverse proxy for Auth0 custom domains.

> **Tested with HAProxy version:** 2.8.5

[Return to main README](../README.md)

## Overview

HAProxy is configured to:
- Listen on port 8080 for HTTP traffic and redirect it to HTTPS
- Listen on port 8443 for HTTPS traffic and proxy it to Auth0
- Use Let's Encrypt SSL certificates
- Add the required `cname-api-key` header to requests to Auth0

## Prerequisites

- HAProxy installed on your system
- Let's Encrypt certificates for your domain
- Environment variables set in `.env` file (created by Terraform)

## Setup

1. Run Terraform to create the Auth0 custom domain and generate the `.env` file:
   ```
   cd ../terraform
   terraform apply
   ```

2. Obtain a Let's Encrypt certificate for your domain:
   ```
   cd letsencrypt
   ./cert <domain>
   ```

3. Start HAProxy:
   ```
   make run
   ```

## Available Commands

- `make` or `make all` - Generate certificate and run HAProxy
- `make run` - Run HAProxy on ports 8080 and 8443
- `make stop` - Stop HAProxy
- `make reload` - Reload HAProxy configuration
- `make log` - View logs
- `make help` - Show help message

## Configuration Files

- `haproxy.cfg.template` - Template for HAProxy configuration
- `haproxy.cfg` - Generated HAProxy configuration (do not edit directly)
- `.env` - Environment variables (generated by Terraform)

## Environment Variables

The following environment variables are required:
- `CNAME_API_KEY` - API key for Auth0 custom domain
- `AUTH0_EDGE_LOCATION` - Auth0 edge location domain
- `DOMAIN_NAME` - Your custom domain name

These variables are automatically set in the `.env` file by Terraform.

## SSL Certificates

HAProxy requires a single file containing both the certificate and private key. The Makefile automatically concatenates the Let's Encrypt certificate and private key files into a single file for HAProxy.

## Troubleshooting

- Check the logs with `make log`
- Ensure the `.env` file exists and contains the required variables
- Verify that the SSL certificates exist in the expected location
- Make sure HAProxy is installed and available in your PATH